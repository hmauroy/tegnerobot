<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <!--Example from: https://docs.opencv.org/4.x/d0/d84/tutorial_js_usage.html -->
    <link rel="shortcut icon" href="https://hmauroy.github.io/8bitHenrik.png">
    <meta name="author" content="Henrik Mauroy">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="image2svg.css">
</head>

<body>
    <h2 class="crt-font">Hello OpenCV.js</h2>
    <p id="status" class="crt-font">OpenCV.js is loading...</p>
    <div id="imageContainer">
        <div class="inputoutput">
            <img id="imageSrc" src="lillebror_newborn512.png" alt="No Image" />
            <div class="caption">imageSrc </div>
        </div>
        <div class="inputoutput">
            <canvas id="canvasOutput"></canvas>
            <div class="caption">filter-output</div>
        </div>
        <div class="inputoutput">
            <canvas id="canvasOutput2"></canvas>
            <div class="caption">svg-output</div>
        </div>
    </div>
    <div class="controls">
        <div><input type="file" id="fileInput" name="file" />  </div>
        <div><input type="range" id="rngBlur" min="3" max="99" value="9" step="1" /><span id="txtBlur">9</span>  </div>
        <div><input type="range" id="rngThresh" min="1" max="99" value="9" step="1" /><span id="txtThresh">9</span></div>
        <div><input type="range" id="rngTurdsize" min="0" max="42" value="8" step="1" /><span id="txtTurd">8</span></div>
        <div><input type="button" id="btnUpdate" value="Update" /></div>
    </div>

    <script type="text/javascript">
        // Listeners
        document.getElementById("btnUpdate").addEventListener("click", (e) => {
            applyFilters();
        });
        document.getElementById("rngBlur").addEventListener("input", (e) => {
            updateSliders();
        });
        document.getElementById("rngThresh").addEventListener("input", (e) => {
            updateSliders();
        });
        document.getElementById("rngTurdsize").addEventListener("input", (e) => {
            updateSliders();
        });
        let width, height;
        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        let canvas = document.getElementById("canvasOutput");
        let ctx = canvas.getContext('2d');
        let canvas2 = document.getElementById("canvasOutput2");
        let ctx2 = canvas2.getContext('2d');
        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
        }, false);
        imgElement.onload = function () {
            // Ensure the canvas size matches the image
            canvas.width = imgElement.width;
            canvas.height = imgElement.height;

            // Draw the image onto the canvas
            ctx.drawImage(imgElement, 0, 0, imgElement.width, imgElement.height);

            //let mat = cv.imread(imgElement);
            //cv.imshow('canvasOutput', mat);
            //mat.delete();
        };
        var Module = {
            // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
            onRuntimeInitialized() {
                document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
            }
        };

        // Functions to apply image trickery + convert to svg.
        function applyFilters() {
            // 1) color to gray
            // 2) median blur, adjusted with slider
            let blur_factor = document.getElementById("rngBlur").value;
            let threshold_factor = document.getElementById("rngThresh").value;
            let turd_factor = document.getElementById("rngTurdsize").value;
            c("Blur: " + blur_factor + ", Thresh: " + threshold_factor + ", TurdSize: " + turd_factor);
            // 3) adaptive threshold, adjusted with slider
            // 4) potrace, turd-size adjusted with slider
            let blur_value = parseInt(Math.round(blur_factor*width*0.01)); // blur value is around 1-2 % of image width
            if (blur_value % 2 == 0) {
                blur_value -= 1
                if (blur_value <= 3) {
                    blur_value = 3;
                }
            }
            let thresh_value = parseInt(Math.round(threshold_factor*width*0.01)); // blur value is around 1-2 % of image width
            if (thresh_value % 2 == 0) {
                thresh_value -= 1
                if (thresh_value <= 0) {
                    thresh_value = 1;
                }
            }
            // Not certain that turd size should be normalized.
            let turd_value = parseInt(Math.round(turd_factor*width*0.01)); // blur value is around 1-2 % of image width
            if (turd_value <= 1) {
                turd_value = 1
            }
        }
        function updateSliders() {
            let blur_factor = document.getElementById("rngBlur").value;
            let threshold_factor = document.getElementById("rngThresh").value;
            let turd_factor = document.getElementById("rngTurdsize").value;
            document.getElementById("txtBlur").innerHTML = blur_factor;
            document.getElementById("txtThresh").innerHTML = threshold_factor;
            document.getElementById("txtTurd").innerHTML = turd_factor;
        }

        function c(text) {
            console.log(text);
        }
    </script>
    <script async src="https://docs.opencv.org/4.5.0/opencv.js" type="text/javascript"></script>
</body>

</html>